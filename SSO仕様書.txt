# ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºè³¼è²·ç®¡ç†SaaS SSOå®Œå…¨å®Ÿè£…ä»•æ§˜æ›¸

## ğŸ“‹ ä»•æ§˜æ¦‚è¦

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: è³¼è²·ç®¡ç†SaaS ã‚·ã‚¹ãƒ†ãƒ  SSOæ©Ÿèƒ½å®Ÿè£…  
**å¯¾è±¡é¡§å®¢**: ä¸­å …ä¼æ¥­ï¼ˆå¹´å•†100-500å„„å††ï¼‰  
**é–‹ç™ºä½“åˆ¶**: 1åï¼ˆAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ´»ç”¨ï¼‰  
**å®Ÿè£…æœŸé–“**: 2-3é€±é–“ï¼ˆMVPï¼‰  
**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: NestJS + Next.js + Azure AD OIDC  

---

## ğŸ¯ ç¢ºå®šä»•æ§˜ä¸€è¦§

### **èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä»•æ§˜**
| é …ç›® | ä»•æ§˜ | å‚™è€ƒ |
|------|------|------|
| **IdPå„ªå…ˆåº¦** | Azure ADï¼ˆMicrosoft Entra IDï¼‰å˜ä½“ | ä¸­å …ä¼æ¥­80%ã‚’ã‚«ãƒãƒ¼ |
| **èªè¨¼ãƒ—ãƒ­ãƒˆã‚³ãƒ«** | OIDCï¼ˆOpenID Connectï¼‰ | å®Ÿè£…åŠ¹ç‡ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒãƒ©ãƒ³ã‚¹ |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±åˆ** | è‡ªå‹•çµ±åˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ï¼‰ | å°å…¥ã‚¹ãƒ”ãƒ¼ãƒ‰é‡è¦– |
| **ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°** | JITï¼ˆJust-In-Timeï¼‰ã®ã¿ | åŸºæœ¬å±æ€§ãƒãƒƒãƒ”ãƒ³ã‚° |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«** | åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆå¿…é ˆæ©Ÿèƒ½ï¼‰ | IPåˆ¶é™ã€ç›£æŸ»ãƒ­ã‚°ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† |

### **é‹ç”¨ãƒ»ç®¡ç†ä»•æ§˜**
| é …ç›® | ä»•æ§˜ | å‚™è€ƒ |
|------|------|------|
| **ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥** | ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ¡ãƒ¼ãƒ«@ä»¥é™ï¼‰ | UXè‰¯å¥½ã€å®Ÿè£…ã‚·ãƒ³ãƒ—ãƒ« |
| **ç®¡ç†è€…æ¨©é™** | æ®µéšçš„æ¨©é™ãƒ¢ãƒ‡ãƒ« | å®‰å…¨æ€§ã¨é‹ç”¨æ€§ã®ãƒãƒ©ãƒ³ã‚¹ |
| **å°å…¥æ–¹å¼** | ãƒ†ãƒŠãƒ³ãƒˆå˜ä½ï¼ˆå…¨ç¤¾ä¸€æ‹¬ï¼‰ã®ã¿ | å®Ÿè£…è¤‡é›‘æ€§ã‚’å›é¿ |
| **ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½** | ç°¡æ˜“æ¥ç¶šãƒ†ã‚¹ãƒˆ | åŸºæœ¬çš„ãªå‹•ä½œç¢ºèªã®ã¿ |
| **ç·Šæ€¥æ™‚å¯¾å¿œ** | ãªã— | ã‚·ãƒ³ãƒ—ãƒ«é‹ç”¨å„ªå…ˆ |

### **æŠ€è¡“å®Ÿè£…ä»•æ§˜**
| é …ç›® | è¨­å®šå€¤ | ç†ç”± |
|------|--------|------|
| **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™** | 8æ™‚é–“ | å–¶æ¥­æ™‚é–“åˆ† |
| **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™** | 7æ—¥ | é€±æ¬¡æ›´æ–° |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** | 8æ™‚é–“ | å–¶æ¥­æ™‚é–“åˆ† |
| **ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸Šé™** | 5å› | èª¤å…¥åŠ›è¨±å®¹ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒãƒ©ãƒ³ã‚¹ |
| **ãƒ‡ãƒ¼ã‚¿åŒæœŸ** | ãƒ­ã‚°ã‚¤ãƒ³æ™‚è‡ªå‹•åŒæœŸ | ä¸€èˆ¬çš„ã§å®Ÿè£…ã‚·ãƒ³ãƒ—ãƒ« |

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆä»•æ§˜

### **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨**
```sql
-- æ—¢å­˜ã®SSOé–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ´»ç”¨ï¼‰
- sso_configuration      -- ãƒ†ãƒŠãƒ³ãƒˆåˆ¥SSOè¨­å®š
- sso_configuration_setting -- è¨­å®šè©³ç´°ï¼ˆKey-Valueï¼‰
- tenant_email_domain    -- ãƒ‰ãƒ¡ã‚¤ãƒ³è­˜åˆ¥ç”¨
- audit_log             -- ç›£æŸ»ãƒ­ã‚°
```

### **æ–°è¦è¿½åŠ ãƒ†ãƒ¼ãƒ–ãƒ«**
```sql
-- SSO ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰
CREATE TABLE sso_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL,
    emp_account_id UUID NOT NULL,
    sso_session_id VARCHAR(255) UNIQUE NOT NULL,
    azure_object_id VARCHAR(255), -- Azure AD Object ID
    initiated_at TIMESTAMP NOT NULL,
    last_accessed TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    ip_address INET,
    user_agent TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (tenant_id) REFERENCES tenant(id),
    FOREIGN KEY (emp_account_id) REFERENCES emp_account(id)
);

-- SSO ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰
CREATE TABLE sso_error_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID,
    correlation_id VARCHAR(255) NOT NULL,
    error_type VARCHAR(50) NOT NULL, -- 'AUTH_FAILED', 'TOKEN_INVALID', 'CONFIG_ERROR'
    error_code VARCHAR(20),
    error_message TEXT,
    provider_error TEXT,
    user_email VARCHAR(255),
    ip_address INET,
    user_agent TEXT,
    resolution_status VARCHAR(20) DEFAULT 'UNRESOLVED',
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹æˆ**
```
src/core/auth/sso/
â”œâ”€â”€ azure-ad/
â”‚   â”œâ”€â”€ azure-ad.strategy.ts          // Passport Strategy
â”‚   â”œâ”€â”€ azure-ad.service.ts           // Azure ADå›ºæœ‰å‡¦ç†
â”‚   â””â”€â”€ azure-ad.config.ts            // è¨­å®šç®¡ç†
â”œâ”€â”€ jit/
â”‚   â”œâ”€â”€ jit-provisioning.service.ts   // JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
â”‚   â””â”€â”€ user-mapping.service.ts       // ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ãƒãƒƒãƒ”ãƒ³ã‚°
â”œâ”€â”€ tenant/
â”‚   â”œâ”€â”€ tenant-resolver.service.ts    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥
â”‚   â”œâ”€â”€ sso-config.service.ts         // ãƒ†ãƒŠãƒ³ãƒˆåˆ¥è¨­å®šç®¡ç†
â”‚   â””â”€â”€ sso-config.controller.ts      // ç®¡ç†API
â”œâ”€â”€ security/
â”‚   â”œâ”€â”€ sso-security.service.ts       // State/Nonceæ¤œè¨¼
â”‚   â””â”€â”€ session-manager.service.ts    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â””â”€â”€ errors/
    â”œâ”€â”€ sso-error.service.ts          // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    â””â”€â”€ sso-error.types.ts            // ã‚¨ãƒ©ãƒ¼å‹å®šç¾©
```

### **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹æˆ**
```
procure-erp-frontend/app/admin/sso/
â”œâ”€â”€ page.tsx                          // ãƒ¡ã‚¤ãƒ³è¨­å®šç”»é¢
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ azure-ad-config.tsx          // Azure ADè¨­å®šãƒ•ã‚©ãƒ¼ãƒ 
â”‚   â”œâ”€â”€ connection-test.tsx          // æ¥ç¶šãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ user-list.tsx               // SSOä½œæˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
â”‚   â””â”€â”€ setup-guide.tsx             // è¨­å®šã‚¬ã‚¤ãƒ‰
â””â”€â”€ lib/
    â”œâ”€â”€ sso-api.ts                   // SSO API client
    â””â”€â”€ sso-validation.ts            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```

---

## ğŸ”§ ä¸»è¦æ©Ÿèƒ½å®Ÿè£…ä»•æ§˜

### **1. Azure AD OIDCèªè¨¼ãƒ•ãƒ­ãƒ¼**

#### **èªè¨¼Strategyå®Ÿè£…**
```typescript
// src/core/auth/sso/azure-ad/azure-ad.strategy.ts
@Injectable()
export class AzureAdStrategy extends PassportStrategy(Strategy, 'azure-ad') {
  constructor(
    private configService: ConfigService,
    private tenantResolver: TenantResolverService,
    private jitService: JitProvisioningService,
    private ssoSecurityService: SsoSecurityService,
  ) {
    super({
      clientID: process.env.AZURE_AD_CLIENT_ID,
      clientSecret: process.env.AZURE_AD_CLIENT_SECRET,
      identityMetadata: 'https://login.microsoftonline.com/common/v2.0/.well-known/openid_configuration',
      responseType: 'code id_token',
      responseMode: 'form_post',
      redirectUrl: `${process.env.BASE_URL}/auth/sso/callback`,
      allowHttpForRedirectUrl: false,
      passReqToCallback: true,
      scope: ['openid', 'profile', 'email'],
      loggingLevel: 'warn',
    });
  }

  async validate(
    req: any,
    iss: string,
    sub: string,
    profile: any,
    accessToken: string,
    refreshToken: string,
    done: Function,
  ) {
    try {
      // 1. State/Nonceæ¤œè¨¼
      const isSecure = await this.ssoSecurityService.validateStateAndNonce(
        req.body.state,
        profile.nonce,
      );
      if (!isSecure) {
        throw new UnauthorizedException('Invalid state or nonce');
      }

      // 2. ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ï¼‰
      const tenant = await this.tenantResolver.resolveTenantByEmail(profile.email);
      if (!tenant) {
        throw new UnauthorizedException('Tenant not found for domain');
      }

      // 3. JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
      const user = await this.jitService.provisionUser(profile, tenant.id);

      // 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
      await this.createSsoSession(user, profile, req);

      return user;
    } catch (error) {
      await this.handleAuthError(error, profile, req);
      return done(error);
    }
  }
}
```

#### **JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å®Ÿè£…**
```typescript
// src/core/auth/sso/jit/jit-provisioning.service.ts
@Injectable()
export class JitProvisioningService {
  
  async provisionUser(azureProfile: any, tenantId: string): Promise<EmpAccount> {
    const email = azureProfile.email.toLowerCase();
    
    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªï¼ˆè‡ªå‹•çµ±åˆï¼‰
    let user = await this.prisma.empAccount.findFirst({
      where: { 
        tenant_id: tenantId,
        email: email 
      }
    });

    if (user) {
      // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±æ›´æ–°ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚è‡ªå‹•åŒæœŸï¼‰
      return await this.updateUserFromAzureAD(user, azureProfile);
    } else {
      // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆåŸºæœ¬ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
      return await this.createUserFromAzureAD(azureProfile, tenantId);
    }
  }

  private async createUserFromAzureAD(
    azureProfile: any, 
    tenantId: string
  ): Promise<EmpAccount> {
    
    const userData = {
      tenant_id: tenantId,
      // åŸºæœ¬ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®‰å…¨é‡è¦–ï¼‰
      first_name: azureProfile.given_name || '',
      last_name: azureProfile.family_name || '',
      email: azureProfile.email.toLowerCase(),
      job_title: azureProfile.job_title || null,
      employee_code: azureProfile.employee_id || null,
      
      // æ‰‹å‹•è¨­å®šé …ç›®ï¼ˆæœªè¨­å®šï¼‰
      department_id: null,
      manager_id: null,
      approval_limit: null,
      status: 'PENDING_SETUP', // åˆæœŸçŠ¶æ…‹
    };

    const user = await this.prisma.empAccount.create({
      data: userData
    });

    // ç®¡ç†è€…é€šçŸ¥
    await this.notifyNewUserCreated(user, tenantId);
    
    return user;
  }

  private async updateUserFromAzureAD(
    user: EmpAccount,
    azureProfile: any
  ): Promise<EmpAccount> {
    
    // ãƒ­ã‚°ã‚¤ãƒ³æ™‚è‡ªå‹•åŒæœŸï¼ˆåŸºæœ¬æƒ…å ±ã®ã¿ï¼‰
    return await this.prisma.empAccount.update({
      where: { id: user.id },
      data: {
        first_name: azureProfile.given_name || user.first_name,
        last_name: azureProfile.family_name || user.last_name,
        job_title: azureProfile.job_title || user.job_title,
        // department_id, manager_id, approval_limit ã¯æ›´æ–°ã—ãªã„
      }
    });
  }
}
```

### **2. ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ã‚·ã‚¹ãƒ†ãƒ **

#### **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹è­˜åˆ¥**
```typescript
// src/core/auth/sso/tenant/tenant-resolver.service.ts
@Injectable()
export class TenantResolverService {
  
  async resolveTenantByEmail(email: string): Promise<Tenant | null> {
    const domain = this.extractDomain(email);
    
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ãƒ†ãƒŠãƒ³ãƒˆæ¤œç´¢
    const tenantDomain = await this.prisma.tenantEmailDomain.findFirst({
      where: { domain: domain },
      include: { tenant: true }
    });

    if (!tenantDomain || !tenantDomain.tenant.sso_enabled) {
      return null;
    }

    return tenantDomain.tenant;
  }

  private extractDomain(email: string): string {
    const parts = email.split('@');
    if (parts.length !== 2) {
      throw new BadRequestException('Invalid email format');
    }
    return parts[1].toLowerCase();
  }

  async registerTenantDomain(tenantId: string, domain: string): Promise<void> {
    await this.prisma.tenantEmailDomain.create({
      data: {
        tenant_id: tenantId,
        domain: domain.toLowerCase(),
        is_primary: true
      }
    });
  }
}
```

### **3. ç®¡ç†ç”»é¢å®Ÿè£…**

#### **SSOè¨­å®šãƒ¡ã‚¤ãƒ³ç”»é¢**
```tsx
// procure-erp-frontend/app/admin/sso/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

export default function SsoConfigPage() {
  const [config, setConfig] = useState<SsoConfig | null>(null);
  const [loading, setLoading] = useState(false);
  const [testResult, setTestResult] = useState<TestResult | null>(null);

  return (
    <div className="container mx-auto py-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">SSOè¨­å®š</h1>
        <p className="text-gray-600">
          Azure ADã¨ã®é€£æºè¨­å®šã‚’è¡Œã„ã¾ã™
        </p>
      </div>

      <Tabs defaultValue="setup" className="space-y-6">
        <TabsList>
          <TabsTrigger value="setup">åŸºæœ¬è¨­å®š</TabsTrigger>
          <TabsTrigger value="test">æ¥ç¶šãƒ†ã‚¹ãƒˆ</TabsTrigger>
          <TabsTrigger value="users">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</TabsTrigger>
          <TabsTrigger value="guide">è¨­å®šã‚¬ã‚¤ãƒ‰</TabsTrigger>
        </TabsList>

        <TabsContent value="setup">
          <Card>
            <CardHeader>
              <CardTitle>Azure ADè¨­å®š</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label htmlFor="tenantId">
                  ãƒ†ãƒŠãƒ³ãƒˆID
                  <span className="ml-1 text-sm text-gray-500">
                    Azure ADã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰ID
                  </span>
                </Label>
                <Input
                  id="tenantId"
                  placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                  value={config?.azure_tenant_id || ''}
                  onChange={(e) => updateConfig('azure_tenant_id', e.target.value)}
                />
              </div>

              <div>
                <Label htmlFor="clientId">
                  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
                  <span className="ml-1 text-sm text-gray-500">
                    Azure ADã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
                  </span>
                </Label>
                <Input
                  id="clientId" 
                  placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                  value={config?.azure_client_id || ''}
                  onChange={(e) => updateConfig('azure_client_id', e.target.value)}
                />
              </div>

              <div>
                <Label htmlFor="clientSecret">
                  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
                  <span className="ml-1 text-sm text-gray-500">
                    Azure ADã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
                  </span>
                </Label>
                <Input
                  id="clientSecret"
                  type="password"
                  placeholder="xxxxxxxxxxxxxxxxxxxxxx"
                  value={config?.azure_client_secret || ''}
                  onChange={(e) => updateConfig('azure_client_secret', e.target.value)}
                />
              </div>

              <div className="flex space-x-2 pt-4">
                <Button onClick={handleSave} disabled={loading}>
                  {loading ? 'ä¿å­˜ä¸­...' : 'è¨­å®šä¿å­˜'}
                </Button>
                <Button variant="outline" onClick={handleTestConnection}>
                  æ¥ç¶šãƒ†ã‚¹ãƒˆ
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="test">
          <Card>
            <CardHeader>
              <CardTitle>æ¥ç¶šãƒ†ã‚¹ãƒˆ</CardTitle>
              <p className="text-sm text-gray-600">
                Azure ADã¨ã®æ¥ç¶šã‚’ç¢ºèªã—ã¾ã™
              </p>
            </CardHeader>
            <CardContent>
              {testResult && (
                <Alert className={testResult.success ? 'border-green-200' : 'border-red-200'}>
                  <AlertDescription>
                    {testResult.success ? (
                      <span className="text-green-600">âœ… æ¥ç¶šæˆåŠŸï¼</span>
                    ) : (
                      <span className="text-red-600">âŒ æ¥ç¶šå¤±æ•—: {testResult.error}</span>
                    )}
                  </AlertDescription>
                </Alert>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="users">
          <Card>
            <CardHeader>
              <CardTitle>SSOä½œæˆãƒ¦ãƒ¼ã‚¶ãƒ¼</CardTitle>
              <p className="text-sm text-gray-600">
                SSOèªè¨¼ã§ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã§ã™
              </p>
            </CardHeader>
            <CardContent>
              <SsoUserList />
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="guide">
          <SetupGuide />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

### **4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

#### **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã‚¨ãƒ©ãƒ¼å‡¦ç†**
```typescript
// src/core/auth/sso/errors/sso-error.service.ts
@Injectable()
export class SsoErrorService {
  
  async handleSsoError(error: any, context: SsoErrorContext): Promise<SsoErrorResponse> {
    const correlationId = this.generateCorrelationId();
    
    // ã‚¨ãƒ©ãƒ¼åˆ†é¡
    const errorInfo = this.classifyError(error);
    
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
    await this.logSsoError({
      correlation_id: correlationId,
      tenant_id: context.tenantId,
      error_type: errorInfo.type,
      error_code: errorInfo.code,
      error_message: errorInfo.message,
      provider_error: JSON.stringify(error.response?.data),
      user_email: context.userEmail,
      ip_address: context.ipAddress,
      user_agent: context.userAgent,
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return {
      userMessage: this.getUserFriendlyMessage(errorInfo.type),
      supportId: correlationId,
      shouldRetry: errorInfo.retryable,
      redirectUrl: this.getRedirectUrl(errorInfo.type),
    };
  }

  private getUserFriendlyMessage(errorType: string): string {
    const messages = {
      'AUTH_FAILED': `
        ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸ
        
        ç¤¾å†…ã®Azure ADã¨ã®é€£æºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
        
        è§£æ±ºæ–¹æ³•:
        1. ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„
        2. å•é¡ŒãŒç¶šãå ´åˆã¯æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ã«ã”é€£çµ¡ãã ã•ã„
      `,
      'CONFIG_ERROR': `
        âš™ï¸ è¨­å®šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
        
        SSOè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
        ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
      `,
      'TOKEN_INVALID': `
        ğŸ”‘ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ©ãƒ¼
        
        èªè¨¼æƒ…å ±ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
        å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
      `,
    };
    
    return messages[errorType] || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
  }
}
```

---

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### **Week 1: æ ¸å¿ƒæ©Ÿèƒ½å®Ÿè£…**
**Day 1-2: åŸºç›¤å®Ÿè£…**
- [ ] Azure AD OIDC Strategyå®Ÿè£…
- [ ] ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ã‚µãƒ¼ãƒ“ã‚¹
- [ ] åŸºæœ¬çš„ãªJITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°

**Day 3-4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…**
- [ ] State/Nonceæ¤œè¨¼
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°åŸºç›¤

**Day 5: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š**
- [ ] æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- [ ] æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«é€£æºç¢ºèª

### **Week 2: ç®¡ç†ç”»é¢å®Ÿè£…**
**Day 1-2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤**
- [ ] SSOè¨­å®šç”»é¢ï¼ˆåŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
- [ ] æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
- [ ] APIå®Ÿè£…

**Day 3-4: UIå¼·åŒ–**
- [ ] è¨­å®šã‚¬ã‚¤ãƒ‰ä½œæˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢
- [ ] ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®æ”¹å–„

**Day 5: çµ±åˆãƒ†ã‚¹ãƒˆ**
- [ ] E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ

### **Week 3: æ¤œè¨¼ãƒ»èª¿æ•´**
**Day 1-2: å®Ÿç’°å¢ƒãƒ†ã‚¹ãƒˆ**
- [ ] Azure ADãƒ†ã‚¹ãƒˆãƒ†ãƒŠãƒ³ãƒˆè¨­å®š
- [ ] å®Ÿéš›ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

**Day 3-4: æ”¹å–„ãƒ»æœ€é©åŒ–**
- [ ] ãƒã‚°ä¿®æ­£
- [ ] UXæ”¹å–„
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€çµ‚ç¢ºèª

**Day 5: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ**
- [ ] è¨­å®šæ‰‹é †æ›¸
- [ ] ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰
- [ ] é‹ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«

---

## ğŸš€ å°å…¥ãƒ»é‹ç”¨ãƒ•ãƒ­ãƒ¼

### **é¡§å®¢å°å…¥æ‰‹é †**
1. **äº‹å‰æº–å‚™**
   - Azure ADç®¡ç†è€…æ¨©é™ç¢ºèª
   - ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ç¢ºèª
   - æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ£šå¸

2. **Azure ADå´è¨­å®š**
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²
   - èªè¨¼è¨­å®š
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š

3. **è³¼è²·ã‚·ã‚¹ãƒ†ãƒ å´è¨­å®š**
   - ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…ãŒSSOè¨­å®šç”»é¢ã§æƒ…å ±å…¥åŠ›
   - æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
   - SSOæ©Ÿèƒ½æœ‰åŠ¹åŒ–

4. **é‹ç”¨é–‹å§‹**
   - ç®¡ç†è€…ã«ã‚ˆã‚‹å‹•ä½œç¢ºèª
   - æ®µéšçš„ãƒ¦ãƒ¼ã‚¶ãƒ¼å±•é–‹ï¼ˆæ¨å¥¨ï¼‰
   - éƒ¨ç½²ãƒ»æ¨©é™ã®æ‰‹å‹•è¨­å®š

### **é‹ç”¨ç›£è¦–é …ç›®**
- [ ] SSOèªè¨¼æˆåŠŸç‡ï¼ˆç›®æ¨™: >99%ï¼‰
- [ ] å¹³å‡èªè¨¼æ™‚é–“ï¼ˆç›®æ¨™: <3ç§’ï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ï¼ˆç›®æ¨™: <1%ï¼‰
- [ ] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆé€šçŸ¥
- [ ] è¨­å®šã‚¨ãƒ©ãƒ¼æ¤œçŸ¥

---

## ğŸ“š æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### **APIä»•æ§˜**
```typescript
// SSOè¨­å®šç®¡ç†API
POST   /api/admin/sso/config          // SSOè¨­å®šä¿å­˜
GET    /api/admin/sso/config          // SSOè¨­å®šå–å¾—
POST   /api/admin/sso/test            // æ¥ç¶šãƒ†ã‚¹ãƒˆ
GET    /api/admin/sso/users           // SSOä½œæˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§

// SSOèªè¨¼API  
GET    /auth/sso/login                // SSOèªè¨¼é–‹å§‹
POST   /auth/sso/callback             // Azure ADã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
POST   /auth/sso/logout               // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
```

### **ç’°å¢ƒå¤‰æ•°**
```bash
# Azure ADè¨­å®š
AZURE_AD_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_AD_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxx

# SSOè¨­å®š
SSO_STATE_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
SSO_CALLBACK_URL=https://your-domain.com/auth/sso/callback
SSO_SESSION_TIMEOUT=28800  # 8æ™‚é–“ï¼ˆç§’ï¼‰
```

### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**
- [ ] HTTPSå¿…é ˆè¨­å®š
- [ ] State ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼å®Ÿè£…
- [ ] Nonceæ¤œè¨¼å®Ÿè£…
- [ ] JWTç½²åæ¤œè¨¼å®Ÿè£…
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒå¯¾ç­–
- [ ] ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°å¯¾ç­–
- [ ] è¨­å®šå€¤æš—å·åŒ–ä¿å­˜
- [ ] ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

---

## âœ… æˆåŠŸæŒ‡æ¨™ãƒ»KPI

### **æŠ€è¡“æŒ‡æ¨™**
- **èªè¨¼æˆåŠŸç‡**: > 99.5%
- **èªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: < 3ç§’ï¼ˆ95%tileï¼‰
- **ã‚·ã‚¹ãƒ†ãƒ å¯ç”¨æ€§**: > 99.9%
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ**: 0ä»¶

### **ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™**
- **é¡§å®¢è¨­å®šå®Œäº†æ™‚é–“**: < 30åˆ†
- **SSOå°å…¥å®Œäº†ç‡**: > 80%ï¼ˆå¯¾è±¡é¡§å®¢ï¼‰
- **ã‚µãƒãƒ¼ãƒˆå•ã„åˆã‚ã›**: < 5ä»¶/æœˆ
- **é¡§å®¢æº€è¶³åº¦**: > 4.5/5.0

### **é‹ç”¨æŒ‡æ¨™**
- **æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå‹•ä½œæˆç‡**: > 95%
- **æ‰‹å‹•è¨­å®šå®Œäº†æ™‚é–“**: < 1æ—¥
- **è¨­å®šã‚¨ãƒ©ãƒ¼è§£æ±ºæ™‚é–“**: < 2æ™‚é–“
- **ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ **: > 99.9%

---

## ğŸ¯ ã¾ã¨ã‚

ã“ã®ä»•æ§˜æ›¸ã«åŸºã¥ã„ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€**ä¸­å …ä¼æ¥­å‘ã‘ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºSaaS**ã¨ã—ã¦ååˆ†ãªå“è³ªã¨æ©Ÿèƒ½ã‚’æŒã¤SSOæ©Ÿèƒ½ã‚’æä¾›ã§ãã¾ã™ã€‚

**å®Ÿè£…ã®éµã¨ãªã‚‹ãƒã‚¤ãƒ³ãƒˆ:**
1. **Azure AD + OIDC**ã«ã‚ˆã‚‹ç¢ºå®Ÿãªèªè¨¼åŸºç›¤
2. **åŸºæœ¬ãƒãƒƒãƒ”ãƒ³ã‚°**ã«ã‚ˆã‚‹å®‰å…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
3. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹è­˜åˆ¥**ã«ã‚ˆã‚‹å„ªã‚ŒãŸUX
4. **æ®µéšçš„æ¨©é™ãƒ¢ãƒ‡ãƒ«**ã«ã‚ˆã‚‹é‹ç”¨æ€§ç¢ºä¿
5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼**ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ç«¶åˆå„ªä½æ€§:**
- å®Ÿè£…ã‚³ã‚¹ãƒˆã‚’æŠ‘åˆ¶ã—ãªãŒã‚‰ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå“è³ªã‚’å®Ÿç¾
- ä¸­å …ä¼æ¥­ã®ãƒ‹ãƒ¼ã‚ºã«æœ€é©åŒ–ã•ã‚ŒãŸæ©Ÿèƒ½ç¯„å›²
- é‹ç”¨è² è·ã‚’æœ€å°é™ã«æŠ‘ãˆãŸè¨­è¨ˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ä½¿ã„ã‚„ã™ã•ã®ãƒãƒ©ãƒ³ã‚¹

ã“ã®ä»•æ§˜ã«ã‚ˆã‚Šã€**å·®åˆ¥åŒ–ã•ã‚ŒãŸSSOæ©Ÿèƒ½**ã‚’æŒã¤è³¼è²·ç®¡ç†SaaSã¨ã—ã¦å¸‚å ´å±•é–‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---

**å®Ÿè£…é–‹å§‹æº–å‚™å®Œäº†** âœ…  
*æ¬¡ã¯å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å®Ÿè£…ã«ç€æ‰‹ã„ãŸã ã‘ã¾ã™*